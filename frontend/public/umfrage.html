<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta
  name="viewport"
  content="height=device-height, initial-scale=1.0, viewport-fit=contain" />
        <!--meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes" /-->
        <title>Münsters Mini-Umfrage</title>
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css?v3" rel="stylesheet" />
    </head>
    <body id="page-top">
        
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg bg-secondary text-uppercase fixed-top" id="mainNav">
            <div class="container">
                <a class="navbar-brand fs-1" href="#page-top">Münsters Mini-Umfrage</a>
                <button class="navbar-toggler text-uppercase font-weight-bold bg-primary text-white rounded" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item mx-0 mx-lg-1"><span class="text-primary
                             py-3 px-0 px-lg-3  fs-1" >Zwei Knöpfe, eine Meinung</span></li>
                    </ul>
                </div>
            </div>
        </nav>
   
        <!-- Icon & Kategorie-->
        <header id="header" class="myheader masthead bg-primary text-white">
            <div class="container d-flex align-items-center flex-row">
              <div class="masthead-icon">
                <img id="masthead-avatar" class="masthead-avatar mb-3" 
                  src="assets/category-icons/tasse.svg" alt="..." />
                  </div>
                <div style="display:inline-block; margin-left:40px" class="masthead-subheading fs-3">
                  <div id="qnum" class="fs-3" style="margin-top:8px;">&nbsp;</div>
                  Umfrage-Kategorie:<br />
                  <b id="category" class="fs-1">Stadtentwicklung & Digitalisierung</b>
                </div>
            </div>
        </header>

        <!-- Frage-->
        <section class=" page-section portfolio" id="portfolio">
            <div class="container">

                <h1 id="question" style="font-size:5em;line-height:1em;margin-bottom:100px" class="page-section-heading text-center text-uppercase mb-7 text-secondary">Liest Du lieber..</h1>

                <!-- Antworten -->
                <div id="answers" class="row justify-content-center">
                    <div class="col-md-6 col-lg-5 mb-5">
                        <div id="a1" class="answer bg-info rounded portfolio-item-caption d-flex flex-column align-items-center justify-content-center h-100 w-100 text-center vibrate">
                            <div class="a1 mt-2">Antwort 1:</div>
                            <h2 id="a1t" class="page-section-heading text-secondary m-5">digital</h2>
                      </div>
                    </div>
                    <div class="col-md-6 col-lg-2 mb-5">
                      &nbsp;                    </div>
                    <div class="col-md-6 col-lg-5 mb-5">
                        <div id="a2" class="answer bg-info rounded portfolio-item-caption d-flex flex-column align-items-center justify-content-center h-100 w-100 text-center vibrate">
                            <div class="a1 mt-2">Antwort 2:</div>
                            <h2 id="a2t" class="page-section-heading text-secondary m-5">digital</h2>
                      </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Auswertung -->
        <section class="page-section portfolio" id="evaluation" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;z-index: 1000; overflow-y: auto;">
            <div class="container-fluid" style="width:70%;margin:auto">
                <h1 class="page-section-heading text-center text-uppercase mt-4 mb-4 text-secondary" style="font-size: 2rem;">
                  Bisherige Umfrageergebnisse</h1>
                <div id="evaluation-content" class="row">
                    <!-- Content will be populated by JS -->
                </div>
                <div class="text-center mt-4">
                    <button id="restart-btn" class="btn btn-primary">Umfrage neu starten</button>
                </div>
            </div>
        </section>
<style>

  .masthead-icon {
    background-color: rgba(var(--bs-secondary-rgb), var(--bs-bg-opacity)) !important;
    border-radius: 40%;
  }
  .answer {
    container-type: inline-size;
     cursor: pointer;
  }
  #answers .answer h2 {font-size: 13cqw; line-height: 13cqw;word-break: break-word;}

/* Animations: highlight selected answer and fade/slide-in new question */
.answer.highlight {
  animation: highlight-pulse 700ms ease-in-out forwards;
  box-shadow: 0 10px 30px rgba(0,0,0,0.28);
  transform: translateY(-6px) scale(1.02);
}
@keyframes highlight-pulse {
  0% { transform: translateY(0) scale(1); filter: brightness(1); }
  50% {  filter: brightness(1.08); opacity: 1}
  100% { transform: translateY(0) scale(1.12); filter: brightness(1.43); opacity: 0 }
}

/* Entrance animation for question and answers (now up to 1s) */
.fade-slide-in {
  animation: fade-slide-in 500ms ease-out forwards;
}
@keyframes fade-slide-in {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0);  }
}

/* Fade-out animation used when a question and the non-chosen answer disappear */
.fade-out {
  animation: fade-out 500ms ease-out forwards;
}
@keyframes fade-out {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to   { opacity: 0; transform: translateY(-12px) scale(0.98); }
}

.vibrate {
  background-color: rgba(var(--bs-info-rgb));
  transform: scale(1);
  box-shadow: 0 0 0 black;
  animation: anim-vibrate 2s infinite;
}
@keyframes anim-vibrate {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(var(--bs-info-rgb), 0.7);
  }
  70% {
    transform: scale(0.97);
    box-shadow: 0 0 0 0.6rem rgba(0, 0, 0, 0);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
  }
}
#evaluation-content .card {
  background-color: #eee;
}
#evaluation {
  transition: opacity 1s ease-out;
  background-image: url('assets/img/sofa.jpg');
  background-size: auto 70%;
  background-position: left bottom;
  background-repeat: no-repeat;
}
.fade-out2 {
  opacity: 0;
}
/* Evaluation chart styles */
.evaluation-chart {
  position: relative;
  height: 40px;
  background: #e9ecef;
  border-radius: 4px;
/*  overflow: hidden; */
  margin: 10px 0;
}
.bar-option1 {
  height: 100%;
  background: #28a745;
  float: left;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}
.bar-option2 {
  height: 100%;
  background: #007bff;
  float: left;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}
.user-marker {
  position: absolute;
  top: -5px;
  width: 4px;
  height: 50px;
  background: #dc3545;
  z-index: 10;
}
.user-marker::after {
  content: 'Du';
  position: absolute;
  top: -20px;
  left: -15px;
  background: #dc3545;
  color: white;
  padding: 2px 4px;
  border-radius: 3px;
  font-size: 20px;
}

</style>

  <!-- body>
    <div class="card">
      <div id="question-area">
        <div class="question" id="question">Loading…</div>
        <div class="answers">
          <button id="a1" class="btn primary">1</button>
          <button id="a2" class="btn">2</button>
        </div>
        <div class="hint">Drücke Taste <strong>1</strong> oder <strong>2</strong> um zu antworten. <a href="/dashboard.html">Auswertung (Dashboard)</a></div>
      </div>
    </div -->

      <script>
      const questionEl = document.getElementById('question');
      const catEl = document.getElementById('category');
      const qnumEl = document.getElementById('qnum');
      let questions = [];
      let currentIndex = 0;
      let userAnswers = []; // Store user's answers
      let inactivityTimer;

      const imgEl = document.getElementById('masthead-avatar')
      const categorymapping = {
        'Mob': 'assets/category-icons/tasche.svg',
        'Bib': 'assets/category-icons/buch.svg',
        'All': 'assets/category-icons/tasse.svg',
        'Spa': 'assets/category-icons/birne.svg',
      }

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          window.location.href = 'start.html';
        }, 60000); // 60 seconds
      }

      async function loadQuestions() {
        try {
          const r = await fetch('/api/questions');
          if (!r.ok) throw new Error('no questions');
          const qs = await r.json();
          if (!Array.isArray(qs) || qs.length === 0) throw new Error('empty');
          // assume server returns questions in the desired order (file order)
          questions = qs;
          currentIndex = 0;
          renderCurrent();
          resetInactivityTimer();
        } catch (err) {
          questionEl.textContent = 'Keine Fragen vorhanden. Füge `data/questions.yml` hinzu.';
          questions = [];
          currentIndex = 0;
          catEl.textContent = '';
          qnumEl.textContent = '';
        }
      }

      function renderCurrent() {
        if (!questions.length) return;
        const q = questions[currentIndex];
        questionEl.textContent = q.question;
        catEl.textContent = q.category || '';
        qnumEl.textContent = `Frage ${currentIndex + 1} von ${questions.length}`;
        document.getElementById('a1t').textContent = q.answer1;
        document.getElementById('a2t').textContent = q.answer2;
        imgEl.src=categorymapping[q.category.substring(0,3)];
        // apply entrance animation to question, category, qnum and answers
        applyEntrance(questionEl);
        applyEntrance(catEl);
        applyEntrance(qnumEl);
        applyEntrance(document.getElementById('a1'));
        applyEntrance(document.getElementById('a2'));
        resetInactivityTimer();
      }

      async function submitAnswer(n) {
        if (!questions.length) return;
        if (window.__animating) return; // prevent double submits during animation
        
        if (currentIndex >= questions.length) {
          // after last question: restart the survey
          document.getElementById('evaluation').classList.add('fade-out2');
          setTimeout(() => {
            location.reload();
          }, 2000);          
        }

        const q = questions[currentIndex];
        const chosenEl = document.getElementById(n === 1 ? 'a1' : 'a2');
        const otherEl = document.getElementById(n === 1 ? 'a2' : 'a1');
        // highlight chosen answer and simultaneously fade out question + non-chosen
        chosenEl.classList.add('highlight');
        // remove the ongoing 'vibrate' animation so fade-out/transform works reliably
        chosenEl.classList.remove('vibrate');
        otherEl.classList.remove('vibrate');
        questionEl.classList.add('fade-out');
        catEl.classList.add('fade-out');
        qnumEl.classList.add('fade-out');
        otherEl.classList.add('fade-out');
        window.__animating = true;
        // wait for animation duration (1s) then submit and advance
        setTimeout(async () => {
          try {
            await fetch('/api/answers', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ questionId: q.id, answer: n })
            });
          } catch (e) {
            /* ignore network errors for now */
          }
          // Store user's answer
          userAnswers.push({ questionId: q.id, answer: n });
          // cleanup fade/highlight classes so renderCurrent can animate fresh
          chosenEl.classList.remove('highlight');
          questionEl.classList.remove('fade-out');
          catEl.classList.remove('fade-out');
          qnumEl.classList.remove('fade-out');
          otherEl.classList.remove('fade-out');
          // advance in ascending order
          currentIndex++;
          if (currentIndex >= questions.length) {
            // All questions answered, show evaluation
            showEvaluation();
          } else {
            renderCurrent();
          }
          // small extra delay to avoid reentrancy
          setTimeout(() => { window.__animating = false; }, 80);
          resetInactivityTimer();
        }, 750);
      }

      function applyEntrance(el) {
        if (!el) return;
        el.classList.remove('fade-slide-in');
        // force reflow to restart animation
        void el.offsetWidth;
        el.classList.add('fade-slide-in');
        // remove class after animation ends to allow re-trigger
        setTimeout(() => {
          el.classList.remove('fade-slide-in');
          // re-enable vibrate on answers after entrance completes
          const a1 = document.getElementById('a1');
          const a2 = document.getElementById('a2');
          if (a1 && !a1.classList.contains('vibrate')) a1.classList.add('vibrate');
          if (a2 && !a2.classList.contains('vibrate')) a2.classList.add('vibrate');
        }, 550);
      }

      async function showEvaluation() {
        // Hide question section, show evaluation
        document.getElementById('portfolio').style.display = 'none';
        document.getElementById('header').style.display = 'none';
        document.getElementById('evaluation').style.display = 'block';

        // Fetch stats
        try {
          const r = await fetch('/api/stats');
          const stats = await r.json();
          const content = document.getElementById('evaluation-content');
          content.innerHTML = '';

          userAnswers.forEach((ua, idx) => {
            const q = questions.find(qq => qq.id === ua.questionId);
            if (!q) return;
            const qStats = stats.byQuestion[ua.questionId] || { '1': 0, '2': 0 };
            const total = qStats['1'] + qStats['2'];
            const userChoice = ua.answer;
            const percent1 = total > 0 ? ((qStats['1'] / total) * 100) : 0;
            const percent2 = total > 0 ? ((qStats['2'] / total) * 100) : 0;
            const markerPosition = userChoice === 1 ? percent1 / 2 : percent1 + percent2 / 2;

            const div = document.createElement('div');
            div.className = 'col-md-6 mb-4';
            div.innerHTML = `
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">${q.question}</h5>
                  <div class="evaluation-chart">
                    <div class="bar-option1" style="width: ${percent1}%">${percent1.toFixed(1)}%</div>
                    <div class="bar-option2" style="width: ${percent2}%">${percent2.toFixed(1)}%</div>
                    <div class="user-marker" style="left: ${markerPosition}%"></div>
                  </div>
                  <div class="row justify-content-center">
                    <div class="col-md-6">
                      <p class="card-text">
                        <strong>${q.answer1}</strong>
                      </p>
                    </div>
                    <div class="col-md-6">
                      <p class="card-text text-end">
                        <strong>${q.answer2}</strong>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            `;
            content.appendChild(div);
          });
        } catch (e) {
          document.getElementById('evaluation-content').innerHTML = '<p>Fehler beim Laden der Auswertung.</p>';
        }
        resetInactivityTimer();
      }

      document.getElementById('a1').addEventListener('click', () => submitAnswer(1));
      document.getElementById('a2').addEventListener('click', () => submitAnswer(2));
      document.getElementById('restart-btn').addEventListener('click', () => {submitAnswer(0);});

      window.addEventListener('keydown', (e) => {
        if (e.key === '1') submitAnswer(1);
        if (e.key === '2') submitAnswer(2);
      });

      // Joystick/Gamepad support
      let gamepadStates = {};

      function checkGamepad() {
        const gamepads = navigator.getGamepads();
        for (let i = 0; i < gamepads.length; i++) {
          const gamepad = gamepads[i];
          if (!gamepad) continue;
          const prevState = gamepadStates[i] || {};
          gamepadStates[i] = {};
          for (let b = 0; b < gamepad.buttons.length; b++) {
            const button = gamepad.buttons[b];
            const pressed = button.pressed;
            const wasPressed = prevState[b] || false;
            gamepadStates[i][b] = pressed;
            if (pressed && !wasPressed) {
              console.log('Gamepad button pressed:', b);
              // Button pressed
              if (b === 0) { // Joystick Button #1
                submitAnswer(1);
              } else if (b === 1) { // Joystick Button #2
                submitAnswer(2);
              }
            }
          }
        }
      }

      // Check for gamepad input every 100ms
      if ('getGamepads' in navigator) {
        console.log('Gamepad API supported');
        setInterval(checkGamepad, 100);
      }

      loadQuestions();
    </script>
  </body>
</html>
