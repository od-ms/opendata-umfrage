<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tabler Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>

span.mysymbol {
    width: 42px;
    height: 42px;
    display: block;
    border-radius: 6px;
    color: white;
    font-size: 20pt;
    text-align: center;
    vertical-align: middle;
    padding-top: 2px;
}
</style>
</head>

<body>
  <div class="page">
    <div class="page-wrapper">
      <!-- BEGIN PAGE HEADER -->
      <div class="page-header d-print-none" aria-label="Page header">
        <div class="container-xl">
          <div class="row g-2 align-items-center">
            <div class="col">
              <!-- Page pre-title -->
              <div class="page-pretitle">Overview</div>
              <h2 class="page-title">Dashboard</h2>
            </div>
            <!-- Page title actions -->
            <div class="col-auto ms-auto d-print-none">
              <div class="btn-list">
                <span class="d-none d-sm-inline">
                  <a href="#" class="btn btn-1"> New view </a>
                </span>
                <a href="#" class="btn btn-primary btn-5 d-none d-sm-inline-block" data-bs-toggle="modal"
                  data-bs-target="#modal-report">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-2">
                    <path d="M12 5l0 14" />
                    <path d="M5 12l14 0" />
                  </svg>
                  Create new report
                </a>
                <a href="#" class="btn btn-primary btn-6 d-sm-none btn-icon" data-bs-toggle="modal"
                  data-bs-target="#modal-report" aria-label="Create new report">
                  <!-- Download SVG icon from http://tabler.io/icons/icon/plus -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="icon icon-2">
                    <path d="M12 5l0 14" />
                    <path d="M5 12l14 0" />
                  </svg>
                </a>
              </div>
              <!-- BEGIN MODAL -->
              <!-- END MODAL -->
            </div>
          </div>
        </div>
      </div>
      <!-- END PAGE HEADER -->
      <!-- BEGIN PAGE BODY -->
      <div class="page-body">
        <div class="container-xl">
          <div id="beispielantworten" class="row row-deck row-cards mb-2">
            <div class="beispielantwort col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <h3 class="h2 atext">Welcome back, Paweł</h3>
                  <span class="aanswer h1 d-inline-flex align-items-center lh-1">
                  </span>

                  <div class="d-flex align-items-baseline mb-2">
                    <div class="acount subheader">25,782</div>

                  </div>
                  <div class="beispielchart" class="position-relative"></div>
                </div>
              </div>
            </div>

            <div class="col-sm-6 col-lg-3">
              <div class="card">
                <div class="card-body">
                  <div class="subheader">Antworten gesamt</div>
                  <div class="d-flex align-items-baseline">
                    <div id="answers_total" class="h1 mb-0 me-2">75,782</div>
                    <div class="me-auto">
                      <span class="text-green d-inline-flex align-items-center lh-1">
                        2%
                        <!-- Download SVG icon from http://tabler.io/icons/icon/trending-up -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon ms-1 icon-2">
                          <path d="M3 17l6 -6l4 4l8 -8" />
                          <path d="M14 7l7 0l0 7" />
                        </svg>
                      </span>
                    </div>
                  </div>
                  <!-- div class="text-secondary mt-2">24,635 users increased from last month</div -->
                </div>
                <div id="chart-visitors" class="position-relative"></div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-6">
              <div class="card">
                <div class="card-body">
                  <div class="subheader">Zuletzt gegebene Antworten</div>
                </div>
                <div class="card-table table-responsive">
                  <table class="table table-vcenter">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Frage</th>
                        <th>Antwort</th>
                      </tr>
                    </thead>
                    <tbody id="latest-questions">
                      <tr>
                        <td class="text-nowrap text-secondary"><span>28 Nov 2019</span></td>
                        <td class="td-truncate text-nowrap">
                          <div class="text-truncate">Fix dart Sass compatibility (#29755)</div>
                        </td>
                        <td class="td-truncate text-nowrap">
                          <div class="text-truncate">Jajajajajajaja</div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
          <div class="row row-cards">
            <div class="col-sm-6 col-lg-3">
              <div class="card card-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span
                        class="bg-primary mysymbol">1</span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">Antwort #1</div>
                      <div id="a1count" class="text-secondary">12 waiting payments</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card card-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span
                        class="bg-secondary mysymbol">2</span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">Antwort #2</div>
                      <div id="a2count" class="text-secondary">32 shipped</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card card-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span
                        class="bg-x text-white avatar"><!-- Download SVG icon from http://tabler.io/icons/icon/brand-x -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-1">
                          <path d="M4 4l11.733 16h4.267l-11.733 -16z" />
                          <path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772" />
                        </svg></span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">623 Shares</div>
                      <div class="text-secondary">16 today</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-lg-3">
              <div class="card card-sm">
                <div class="card-body">
                  <div class="row align-items-center">
                    <div class="col-auto">
                      <span
                        class="bg-facebook text-white avatar"><!-- Download SVG icon from http://tabler.io/icons/icon/brand-facebook -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                          class="icon icon-1">
                          <path d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3" />
                        </svg></span>
                    </div>
                    <div class="col">
                      <div class="font-weight-medium">132 Likes</div>
                      <div class="text-secondary">21 today</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js">
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      window.ApexCharts &&
        new ApexCharts(document.getElementById("chart-visitors"), {
          chart: {
            type: "line",
            fontFamily: "inherit",
            height: 96,
            sparkline: {
              enabled: true,
            },
            animations: {
              enabled: false,
            },
          },
          stroke: {
            width: [2, 1],
            dashArray: [0, 3],
            lineCap: "round",
            curve: "smooth",
          },
          series: [
            {
              name: "Visitors",
              data: [
                7687, 7543, 7545, 7543, 7635, 8140, 7810, 8315, 8379, 8441, 8485, 8227, 8906, 8561, 8333, 8551, 9305, 9647, 9359, 9840, 9805, 8612, 8970,
                8097, 8070, 9829, 10545, 10754, 10270, 9282,
              ],
            },
            {
              name: "Visitors last month",
              data: [
                8630, 9389, 8427, 9669, 8736, 8261, 8037, 8922, 9758, 8592, 8976, 9459, 8125, 8528, 8027, 8256, 8670, 9384, 9813, 8425, 8162, 8024, 8897,
                9284, 8972, 8776, 8121, 9476, 8281, 9065,
              ],
            },
          ],
          tooltip: {
            theme: "dark",
          },
          grid: {
            strokeDashArray: 4,
          },
          xaxis: {
            labels: {
              padding: 0,
            },
            tooltip: {
              enabled: false,
            },
            type: "datetime",
          },
          yaxis: {
            labels: {
              padding: 4,
            },
          },
          labels: [
            "2020-06-21",
            "2020-06-22",
            "2020-06-23",
            "2020-06-24",
            "2020-06-25",
            "2020-06-26",
            "2020-06-27",
            "2020-06-28",
            "2020-06-29",
            "2020-06-30",
            "2020-07-01",
            "2020-07-02",
            "2020-07-03",
            "2020-07-04",
            "2020-07-05",
            "2020-07-06",
            "2020-07-07",
            "2020-07-08",
            "2020-07-09",
            "2020-07-10",
            "2020-07-11",
            "2020-07-12",
            "2020-07-13",
            "2020-07-14",
            "2020-07-15",
            "2020-07-16",
            "2020-07-17",
            "2020-07-18",
            "2020-07-19",
            "2020-07-20",
          ],
          colors: ["color-mix(in srgb, transparent, var(--tblr-primary) 100%)", "color-mix(in srgb, transparent, var(--tblr-gray-400) 100%)"],
          legend: {
            show: false,
          },
        }).render();
    });
  </script>
  <script>
    function showRadialChart(ele, amount) {
      window.ApexCharts &&
        new ApexCharts(ele, {
          chart: {
            type: "radialBar",
            fontFamily: "inherit",
            height: 192,
            sparkline: {
              enabled: true,
            },
            animations: {
              enabled: false,
            },
          },
          plotOptions: {
            radialBar: {
              startAngle: -120,
              endAngle: 120,
              hollow: {
                margin: 16,
                size: "50%",
              },
              dataLabels: {
                show: true,
                value: {
                  offsetY: -8,
                  fontSize: "24px",
                },
              },
            },
          },
          series: [amount],
          labels: [""],
          tooltip: {
            theme: "dark",
          },
          grid: {
            strokeDashArray: 4,
          },
          colors: ["color-mix(in srgb, transparent, var(--tblr-primary) 100%)"],
          legend: {
            show: false,
          },
        }).render();

    }
  </script>

  <script>
    function el(tag, text) { const e = document.createElement(tag); if (text) e.textContent = text; return e }

    async function loadData() {
      const [questionsRes, statsRes, answersRes] = await Promise.all([
        fetch('/api/questions'),
        fetch('/api/stats'),
        fetch('/api/answers?limit=50')
      ]);
      const questions = await questionsRes.json();
      const stats = await statsRes.json();
      const answers = await answersRes.json();

      // get list of all questions by id
      var allQuestions = {};
      questions.forEach(q => { allQuestions[q.id] = q });

      // Show total number of questions
      const answers_count = stats.totals[1] + stats.totals[2];
      document.getElementById('answers_total').textContent = answers_count.toLocaleString();

      // Show latest answers
      var clone = document.querySelector('#latest-questions tr').cloneNode(true);
      const latestQuestionsArea = document.getElementById('latest-questions');
      latestQuestionsArea.innerHTML = '';
      answers.slice(0,5).forEach(a => {
        const tr = clone.cloneNode(true);
        const qst = allQuestions[a.question_id];
        tr.children[1].children[0].textContent = qst.question;
        tr.children[2].children[0].textContent = a.answer === '1' ? qst.answer1 : qst.answer2;
        tr.children[0].children[0].textContent = new Date(a.ts).toLocaleString().substring(12, 17);
        latestQuestionsArea.appendChild(tr);
      });

      // Show one answer
      var randomProperty = function (obj) {
        var keys = Object.keys(obj);
        return keys[keys.length * Math.random() << 0];
      };
      var clone = document.querySelector('#beispielantworten .beispielantwort').cloneNode(true);
      document.querySelector('#beispielantworten .beispielantwort').remove();
      var randomAnswerNr = randomProperty(stats.byQuestion);
      for (i=0; i<4; i++) {
        const myTotal = stats.byQuestion[randomAnswerNr]['1'] + stats.byQuestion[randomAnswerNr]['2'];
        const tr = clone.cloneNode(true);
        tr.querySelector('.atext').textContent = allQuestions[randomAnswerNr].question;
        tr.querySelector('.aanswer').textContent = allQuestions[randomAnswerNr].answer1;
        tr.querySelector('.acount').textContent = (stats.byQuestion[randomAnswerNr]['1']).toLocaleString() + " von " + myTotal.toLocaleString();
        document.getElementById('beispielantworten').appendChild(tr);
        showRadialChart(tr.querySelector('.beispielchart'), Math.round((stats.byQuestion[randomAnswerNr]['1'] / myTotal) * 100));
        randomAnswerNr = ((randomAnswerNr + 1) % questions.length) +1;
      }

      // count answers
      document.getElementById("a1count").textContent = stats.totals['1'] + " mal gewählt";
      document.getElementById("a2count").textContent = stats.totals['2'] + " mal gewählt";
    }









    function dummy() {

      // Per question
      const qa = document.getElementById('questions-area'); qa.innerHTML = '';
      const qTable = el('table');
      const hdr = el('tr'); hdr.appendChild(el('th', 'Frage')); hdr.appendChild(el('th', 'Antwort 1')); hdr.appendChild(el('th', 'Antwort 2')); qTable.appendChild(hdr);
      for (const q of questions) {
        const counts = stats.byQuestion && stats.byQuestion[q.id] ? stats.byQuestion[q.id] : { '1': 0, '2': 0 };
        const tr = el('tr'); tr.appendChild(el('td', q.question)); tr.appendChild(el('td', String(counts['1'] || 0))); tr.appendChild(el('td', String(counts['2'] || 0))); qTable.appendChild(tr);
      }
      qa.appendChild(qTable);

      // Timeline: aggregate 15-minute buckets
      const area = document.getElementById('timeline-area'); area.innerHTML = '';
      if (!answers.length) { area.textContent = 'Keine Antworten vorhanden.'; return }
      // compute bucket key
      const BUCKET = 15 * 60 * 1000;
      const counts = {};
      let minTs = Infinity, maxTs = 0;
      answers.forEach(a => {
        const b = Math.floor(a.ts / BUCKET) * BUCKET;
        counts[b] = (counts[b] || 0) + 1;
        if (a.ts < minTs) minTs = a.ts;
        if (a.ts > maxTs) maxTs = a.ts;
      });
      // build sorted buckets from min to max
      const rows = [];
      for (let t = Math.floor(minTs / BUCKET) * BUCKET; t <= maxTs; t += BUCKET) {
        rows.push({ ts: t, cnt: counts[t] || 0 });
      }
      const tlTable = el('table');
      const htr = el('tr'); htr.appendChild(el('th', 'Intervall')); htr.appendChild(el('th', 'Anzahl')); tlTable.appendChild(htr);
      rows.forEach(r => {
        const tr = el('tr'); tr.appendChild(el('td', new Date(r.ts).toLocaleString())); tr.appendChild(el('td', String(r.cnt))); tlTable.appendChild(tr);
      });
      area.appendChild(tlTable);
    }

    loadData().catch(err => { console.error(err); document.body.appendChild(el('div', 'Fehler beim Laden der Daten')) });
  </script>
</body>